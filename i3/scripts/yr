#!/bin/bash

# exit on network failure
~/.config/i3/scripts/online > /dev/null
if [ $? == 1 ]; then
  exit 0
fi

FORECAST_URL='http://www.yr.no/sted/Norge/Oslo/Oslo/Oslo_(Blindern)_målestasjon'
DATA=`curl -s "$FORECAST_URL/varsel.xml"`

get_param() {
  echo "$DATA" | grep -oP "$1" | head -1
}
TEMP=`get_param '(?<=<temperature unit="celsius" value=")(-)?[0-9]*'`
WEATHER_REALTIME=`get_param '(?<=<symbol number="4" name=")[A-Za-zæøå]*'`
WEATHER_CLOSEST_PRED=`get_param '(?<=<symbol number="4" numberEx="4" name=")[A-Za-zæøå]*'`
WIND_SPEED=`get_param '(?<=<windSpeed mps=")[0-9]*.[0-9]*'`
WIND_NAME=`get_param '(?<=<windSpeed mps=")([0-9]*.[0-9]*" name=")[A-Za-zæøå ]*' | grep -oP '(?<=name=").*'`

if [[ "$WEATHER_REALTIME" == "" ]]; then
  WEATHER=$WEATHER_CLOSEST_PRED
else
  WEATHER=$WEATHER_REALTIME
fi

shopt -s nocasematch
case $WEATHER in
klarvær|lettskyet)
  WEATHER_UNICODE="f185"
  WEATHER_COLOR="#f4eb42"
  ;;
*skyet)
  WEATHER_UNICODE="f0c2"
  WEATHER_COLOR="gray"
  ;;
*regn)
  WEATHER_UNICODE="f043"
  WEATHER_COLOR="#2b9ee5"
  ;;
*)
  WEATHER_UNICODE="f128"
  WEATHER_COLOR="gray"
  ;;
esac

DOT="<span color='$WEATHER_COLOR'><b>&#x$WEATHER_UNICODE;</b></span>"

if [[ $BLOCK_BUTTON == 1 ]]; then
  echo "$DOT $WEATHER: <b>$TEMP°C</b> <i>($WIND_NAME, $WIND_SPEED m/s)</i>"
elif [[ $BLOCK_BUTTON == 3 ]]; then
  chromium-browser $FORECAST_URL &
else
  echo "$DOT $TEMP°C"
fi
